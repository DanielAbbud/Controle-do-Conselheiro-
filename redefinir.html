<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redefinir Senha - Controle DBV</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <header>
        <div class="header-content" style="justify-content: center;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <img src="logo.png" alt="Bras√£o" class="logo-header">
                <div>
                    <h1 style="margin: 0;">Controle de Unidade</h1>
                    <small>Recupera√ß√£o de Acesso</small>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="card login-card" style="max-width: 500px; margin: 50px auto;">

            <div id="loading-box" style="text-align: center;">
                <h3>üîÑ Verificando...</h3>
                <p>Aguarde enquanto validamos seu link.</p>
            </div>

            <div id="reset-box" class="hidden">
                <h2 style="color: #E65100; text-align: center;">Nova Senha</h2>
                <p style="text-align: center; color: #666; margin-bottom: 20px;">
                    Digite sua nova senha abaixo para recuperar o acesso.
                </p>

                <input type="password" id="new-password" placeholder="üîí Nova Senha (m√≠n. 6 caracteres)">
                <button id="btn-save-pass" class="btn btn-primary">üíæ Salvar Nova Senha</button>
            </div>

            <div id="success-box" class="hidden" style="text-align: center;">
                <h2 style="color: #4CAF50;">‚úÖ Sucesso!</h2>
                <p>Sua senha foi alterada.</p>
                <a href="index.html" class="btn btn-primary"
                    style="text-decoration: none; display: inline-block; margin-top: 10px;">
                    Voltar para o Login
                </a>
            </div>

            <div id="error-box" class="hidden" style="text-align: center;">
                <h2 style="color: #f44336;">‚ùå Link Inv√°lido</h2>
                <p id="error-msg">Este link j√° foi usado ou expirou.</p>
                <a href="index.html" class="btn btn-secondary" style="text-decoration: none; display: inline-block;">
                    Voltar
                </a>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, confirmPasswordReset, verifyPasswordResetCode } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAuorMQnlj-SCwFsPOEBKnqj2im6VVLcHk",
            authDomain: "controle-de-unidade.firebaseapp.com",
            projectId: "controle-de-unidade",
            storageBucket: "controle-de-unidade.firebasestorage.app",
            messagingSenderId: "344553489715",
            appId: "1:344553489715:web:fa19c9387e4e32688b2a46"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Pega o c√≥digo secreto da URL (que vem do email)
        const urlParams = new URLSearchParams(window.location.search);
        const oobCode = urlParams.get('oobCode');
        const mode = urlParams.get('mode');

        const boxLoading = document.getElementById('loading-box');
        const boxReset = document.getElementById('reset-box');
        const boxSuccess = document.getElementById('success-box');
        const boxError = document.getElementById('error-box');

        if (!oobCode || mode !== 'resetPassword') {
            mostrarErro("Link inv√°lido ou incompleto.");
        } else {
            // Verifica se o c√≥digo √© v√°lido
            verifyPasswordResetCode(auth, oobCode)
                .then(email => {
                    // C√≥digo v√°lido! Mostra o formul√°rio
                    boxLoading.classList.add('hidden');
                    boxReset.classList.remove('hidden');
                })
                .catch(error => {
                    mostrarErro(error.message);
                });
        }

        document.getElementById('btn-save-pass').addEventListener('click', () => {
            const newPass = document.getElementById('new-password').value;
            if (newPass.length < 6) return alert("A senha deve ter pelo menos 6 caracteres.");

            confirmPasswordReset(auth, oobCode, newPass)
                .then(() => {
                    boxReset.classList.add('hidden');
                    boxSuccess.classList.remove('hidden');
                })
                .catch(error => {
                    alert("Erro ao salvar: " + error.message);
                });
        });

        function mostrarErro(msg) {
            boxLoading.classList.add('hidden');
            boxError.classList.remove('hidden');
            document.getElementById('error-msg').innerText = "O link expirou ou j√° foi usado.";
        }
    </script>
</body>

</html>